/*
   Copyright 2021 Erigon contributors

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/

package txpool

import (
	"encoding/hex"
	"fmt"
	"strconv"
	"testing"

	"github.com/stretchr/testify/require"
)

func decodeHex(in string) []byte {
	payload, err := hex.DecodeString(in)
	if err != nil {
		panic(err)
	}
	return payload
}

var hashParseTests = []struct {
	payloadStr  string
	hashStr     string
	expectedErr bool
}{
	{payloadStr: "a0595e27a835cd79729ff1eeacec3120eeb6ed1464a04ec727aaca734ead961328", hashStr: "595e27a835cd79729ff1eeacec3120eeb6ed1464a04ec727aaca734ead961328", expectedErr: false},
}

func TestParseHash(t *testing.T) {
	for i, tt := range hashParseTests {
		t.Run(strconv.Itoa(i), func(t *testing.T) {
			require := require.New(t)
			var hashBuf [32]byte
			payload := decodeHex(tt.payloadStr)
			_, parseEnd, err := ParseHash(payload, 0, hashBuf[:0])
			require.Equal(tt.expectedErr, err != nil)
			require.Equal(len(payload), parseEnd)
			require.Equal(decodeHex(tt.hashStr), hashBuf[:])
		})
	}
}

var hashEncodeTests = []struct {
	payloadStr  string
	hashesStr   string
	hashCount   int
	expectedErr bool
}{
	{payloadStr: "e1a0595e27a835cd79729ff1eeacec3120eeb6ed1464a04ec727aaca734ead961328",
		hashesStr: "595e27a835cd79729ff1eeacec3120eeb6ed1464a04ec727aaca734ead961328", hashCount: 1, expectedErr: false},
	{hashesStr: fmt.Sprintf("%x", toHashes([32]byte{1}, [32]byte{2}, [32]byte{3})),
		payloadStr: "f863a00100000000000000000000000000000000000000000000000000000000000000a00200000000000000000000000000000000000000000000000000000000000000a00300000000000000000000000000000000000000000000000000000000000000", hashCount: 3, expectedErr: false},
}

func TestEncodeHash(t *testing.T) {
	for i, tt := range hashEncodeTests {
		t.Run(strconv.Itoa(i), func(t *testing.T) {
			require := require.New(t)
			var encodeBuf []byte
			encodeBuf = EncodeHashes(decodeHex(tt.hashesStr), encodeBuf)
			require.Equal(decodeHex(tt.payloadStr), encodeBuf)
		})
	}
}

var gpt66EncodeTests = []struct {
	payloadStr  string
	hashesStr   string
	hashCount   int
	requestId   uint64
	expectedErr bool
}{
	{payloadStr: "e68306f854e1a0595e27a835cd79729ff1eeacec3120eeb6ed1464a04ec727aaca734ead961328",
		hashesStr: "595e27a835cd79729ff1eeacec3120eeb6ed1464a04ec727aaca734ead961328", hashCount: 1, requestId: 456788, expectedErr: false},
}

// TestEncodeGPT66 tests the encoding of GetPoolTransactions66 packet
func TestEncodeGPT66(t *testing.T) {
	for i, tt := range gpt66EncodeTests {
		t.Run(strconv.Itoa(i), func(t *testing.T) {
			require := require.New(t)
			var encodeBuf []byte
			var err error
			encodeBuf, err = EncodeGetPooledTransactions66(decodeHex(tt.hashesStr), tt.requestId, encodeBuf)
			require.Equal(tt.expectedErr, err != nil)
			require.Equal(decodeHex(tt.payloadStr), encodeBuf)
			if err != nil {
				return
			}
			requestID, hashes, _, err := ParseGetPooledTransactions66(encodeBuf, 0, nil)
			require.Equal(tt.expectedErr, err != nil)
			require.Equal(tt.requestId, requestID)
			require.Equal(decodeHex(tt.hashesStr), hashes)
		})
	}
}

var ptp66EncodeTests = []struct {
	txs         [][]byte
	encoded     string
	requestId   uint64
	expectedErr bool
}{
	{
		txs: [][]byte{
			decodeHex("f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10"),
			decodeHex("f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb"),
		},
		encoded: "f8d7820457f8d2f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb", requestId: 1111, expectedErr: false},
}

func TestName(t *testing.T) {
	bb := decodeHex("f9210c88aa4d54690656515df92100a0c008fe869a2f409634166b1bb6de438ed10724f11d4138a8dbe6cb5f2b5580e6a022cacdb7b0b1e8bb588fcf48153fd20682f31d2f659fad5e0229345ef6d86fbba0e19ebcecfe93a1ec59880aa8984a439297a29577b0a5520c2de4247cbd63a652a04236fac77190e5c7b97058a0f75adb6bb3954821314d3b1b4a63e0bdb99a791fa0b7cae28aba273a784619f54209a63dc21a7e1a11c5d4a864ef9d9d8897ab7398a0f35fea9b52a00fec300b6806d1954750b6f585d050505de47041eeb728a20b6fa062c6a0e1e2812e9556033a580b896f6b2f7c08bc5b5355dd1e993517332512c0a0c1dfc77b5e533c926b8b4495e8d2ed12412eb036d98ac3eaed0a7c64c9433bf8a00c5f0b76121f2f5c185e7f3b08fbb4c4563f0f107cc4695b4a2e84e50a28aa27a0eac246f6f69f2c2b76411a43d515b386573ba04bc45a7956c278c79dba7bb61fa0e47c2055e398ca5002f92e9ba89b7c03cae7cbcd4f7bd04c25c2254fb2d19004a031b049662cd9871f4df2d7c642b8b40d6474e5704abd05ed1356897020310b1aa0b7beed4978fe63128718ecf360f8968249c76fd39230e92377f12275e9aa4e47a080581eab5455571cbda9b55d998a710d1fb9050995b4fb9b2de81b8d881804d4a0251a23ab456fc3d0448a83527657c5b0c2c87452c4b9164fb3e848587c6055e0a03054aaa9c70f32df46ae15d52bbb635bcd6871f987ed34abb5d2b54ccebf84a6a0bc9325da5cbf5b838b93eac35ba1646de6dd1147bee08630c3ad212096330c4da03297163e2ed7c2ecac0ae42a2545649e893d0d5724ef61d807908a8702fa4c52a0f60050e4e5533cbb9f23204bf4f4bda5d44a532f15b4852bb219ab77108a898aa05f7c6efc2763a566c1cba00767b73bfaf6f6a68c9586d6217df18eea84cde4f3a0c0a009647952b803801e20c8c458b3ea27dac2b27d775e1671a4a2472d87b955a0c6562f657c03ff490b5e8a562145fe31bcb316c333c91e2966db8dc02c1cd9bfa049c89e64bcfaee4cab7c908cfe9371c4b73543fe7fbf469c4d11787cf7c11715a0992b99d8f0aea6aa6d519b38ff80129a5ba4fa3d1769aa87b6ce8fc7a21babe4a0253f01461847d3ef217d7ebc33beebb64d63d98698d384825341c2a10aef8df9a08ba58c0b4c29f36b9126210ce2a123c4ea159f32e016e320ea06f17b535ee7f5a0c606e1bbcd6d6d69b252cfbd6aa8a4353b586b80c43bde29568c8f8918015c28a066942a0a882104d2f331c078e86429a271ca99765298ef60ffff713cfa6ff383a06bb6aa58fbf359909226150cd5a7412f6e6b58b16fa8ef1f899b57a82b0b3b9ca02bfbc4a9557c60ead64c449e21dec39075369d85729095d69771273af5cb632ca015048dfa17fa02906243bf3d929623ab3f22a0c5f09874106805bfab8b767123a0919fe156a6cdd049a6cfcbd063a25fe27f7b36b8f1ade9f253db174879e2e87ea08ef5c68dcad81e32ed4c492aecdc31cf4478aca7d8eeb86505f1e1ebce67e118a011cd2533b889a8ab424440e63246e48b7ee48a7f5d924f92301d3d6316c0ea1ba0ca1d687cf59b4f8102678cd983bde13738ca098978abd2c6d460264d49b95a56a0b5f9dc66bc38db6c762762a6c9ebc52cb5bdb2ee994924e353e3aadca3764368a08b2d92fcaec1e5d2cc910b6a94c1b514ca167187739f79d5aeaa40514a29c9cda0a88ffe60eda6d8a38322841122e2bb50516dd529af7d090c67f0a38bc0d81656a01bfe80259613c42877fd2e9b8fdd6dc533d23013fc790c4347d144f274c5c1b8a0f12f6cac6d786a308ab74e7eec4e68ad45fb46da097587b32153e3b451f4d4afa0c507d1af8263f80abfb839e17007111d4b5cfc0358dc3be9211358ad3b329bf1a0d58c730448774c0044b7b2c76c5b1939ab79fd3e3722224f2f922cd944111554a04c306343634f490d9ec371a85377deffbd3c16b315f37bfd708fd657d43866a8a0843f921a4f88693a57c68509fdd211d1bc3dc5a79fa8b1f942e42d5c64cc2d20a00a474e5a6bed65dec824bdc8b991bad2bfb8a399fccdda2d6a4b4f7d43da91b8a0df69821f82be3d320e26bbc0b00eafcbc47e59aab1e6b14832b13ad81e4aee04a08e29949300034827aaa01523bd0e505a941bb91557c72f5d808284a4b0e2f60ba0254e9dc205ca70e846404e4e40ba98c537fc3b6c0e69caa7669256f5099b8fb7a0d997617f145f5cc7c5fbf0f723f653c398fdb01e60633a72b701c69162f6b1c4a0a1b11a6112fd1d8ee50b808f1358d12ddd13c4d9467dc244add93633e76b0e78a039b79583a80e51868ca56d635b06a0b9d60fc9af6df86a62507d0fafe9c9b643a0eb04526f61d95064d9a6db45c12d2a2957a77dcc7d8ad9a05375b687c27b4fa1a0f3a9b5796b362df64eaeaeaa4f6b37b6d6959d5e5a1a1f085ca25d912ed67b83a00a07852808336894bb646fbd4e6f641a34ec234c87a40bdebdbf367bccd02d67a006d52083a19c84fdf02a7c0516f15f42baebf7b4dba9cb737aa4876a7e3abdc8a00f61a65b864471f322daeab9205c1c353161a47469769b882fcaee25830eafc4a00a920a44dce28349aea08e15e2c0923dadf236db178742d0320022570c93e79fa0f8a7cdb04aef9c6d023a8cca004026f3341509eca0646a12f528fcec9a80de24a028922b0a7b290a99a5eb7f86cedc9c425525e2a9b004b862e0fc7c42dba12145a017dc01f59930cfe6afe18fe2a93ca28c018cb89bea246cc187d14b7aaa6c4281a0d780df3c1f89aa9eecc7fb150dd7fed493423a9bb0a48dd196e5fe930673d592a0211839e647fa25ef9be0a9f483df17f4b7d908ceb9ceb1753191101fda521e40a0a4280e1f5c102c25322808ecec0c44e6b621b91547a129c52f516b7f2a9215aba072cec3e86842d423be268aa21003ff1a7e520ee47326687bf09a85f5d8771363a00932982d1cfd53c1068be0235f19971ef334631e00f9307bc54d4661869b8808a0b20f84dac9677461a4f4a4e308a189d87489e94ee3d651bb5d52900c158301cca09b1b8d2ec8501d00565adc56b1d7bbb7e1ef7c586a027a4269fe4ae5f0293034a0a17867c0cdb8825c3a42b16489a9fed5624a5cb8773a8e75b1407047e34b73d2a0788b43127099241dc41d63280d84b97c5ad76c5eb3bb8d34ae91ebf3a7464964a0956aab804178d40fcd2e740b3f785b9a0ec6dd9c005581091fc238d2f89f66f0a080e2dbce716472c8e405de66f5889df1ee6f2c221e4253bdc2589329c47ad0c0a0a6e8634d576faaf335a87490fb685bfeeb8aef743de2d02534aa37fbcd27f61ca0f6e448ac818ef325f31dd9efb3cb70fc4dd972bf2a8c96dc05f0458deef163c8a02109755a733858b948b39405621d45378c2a8d884bd39c27abf0438fcf456a43a01fe4c2edf2c849d28600c28cb2310fc6f495bb591aaa09d823c1a7950a69cbaba042e0d196b4aa84807f8fbd89eb9d2171b4ab9d37edbc8d20c604a21571078786a02037afd0f51a47472d5a1dc05f75a70c55d34b8871524619092e4e449007ca10a00b65f739ce249845318a1b945804a98a901273e5abe3bd01f8fd9e22c1ccba64a040b212a7a336b03605a020e9e358a6ad653b2828ad8bba2b72b9f94c5b9009a0a0286b28b1660fcab4b0a4b5dd1e6c7ffc4eacb5ad5e2c886e82037dee212df6e9a04be0f69a355d4d232c3dcab97c6e02299eef49d94a55db04b6426034458eca06a0862199de2a658801175ef187e07a3e4a1af5084baa4a8bd2c1ca0e1b1bac18eba0ea509a26bf14edf517098e5ded30f9ae96f39ba614d113e3214a15e8cfa3a17ea05f7c60a1165c83ccf60d1df56cabe90d65cc4703ba9057b7949d6c583a1378a4a08954c3a166e66bd395d4771744b6d07ec780338a4a2cb95b83f0da5a750a6267a0fc812d85f4f8b698efe47dcff7eeb0c1bdf544282f9be2e0f7c0d7778db99374a0f9ed17e30c78e646b1bc66ed360e3decf415f91a2219d2e7e704ab6de00e8a48a0b246ab7806755fcc575b3fab0f9523c00e6bef2e44ebd9ccb766740914a705a7a02977a649b0e01f57014efc04b390acfb5ec65770f838a2d02b9f706c8f1ea893a0f6d99a4e18f87374b6b0cc7ab95edf41e56d0a27339bd601fb047376d93d1554a080c1b9da72162180d48147958ca2a79d5ed159477ac702365121bf450616cf74a081c641e7ed69388b8ac6795a0cd52e5742d3db29df1a67f61273e44f75dffd7fa038779fad7e840b8ea4807eedc21869ceaedb59d5b81d5413538cf5eba12b9feca073f12bdd439c8aeb901cae59a3a0706337f3a27bdd7f34fa9f8ec8e03326f246a040b100c024d4c8b7f02262805c30057e43aa810d4dc8422d90896dbadb6b5db3a0d24b4d33716f49a3e1150af38cf7329f457b024f75fc492a1285cc6692ba6ed0a0ac3f2811e037b8739e8ee6416286ca02e2d47347738a501bb57571ad60949bbea01611038af82a500f312cc76830f5cd0a234da9b286ac24166200f6a745b31d48a035d4e152c7d86fad1c29f6d89d2d811da11f780857fe9d40ed62f8853f36de20a0b7a2fbc14519e376afec596ac65d368423a9a2a7b20b28d75f27d5c5975ab6baa09ac0a7fff534ce60e33424ce04d5fe1025120e0851bbca043f16b77e23324777a0ec481b4de8ecc61e8945d42e71c6b70149d13cc6bee5c79c4c2c660a0fed3c9da06f58d5d8dae307d1c27b26fb1a1e9a2fc4d4a8f38b5c76b802c7351ec96d1409a08746638313b1d5c44f04d37ed085adcff3f6d10224682f5157b4327fdc8ad1b1a0bcad3541a57059fd1dfa74ba5f60634f79740eccadb39ec8b58356b34a98af14a0b38e83d9c077337d371c967528cc0ae6a6ce64caceaf16e34e7c67df0cd8eca5a0d88696ce6811069be9476b22554e92b47de4d98f7977a29f2d95a7a55b030620a069843e8ad51b890b2ea0ca361ea006ce48e68d77f04383987f12b437519473a2a0e4732c3684840a33bfbea84e22c5c78c0c4944ce7cd2d4bb24845fdc4b60b31ba06d7b6a246ff0c48b237ac70f0a51a5923f82db4e98ec297702b339d92a55f613a02bd3ca79c223e951f2108fe23ab4691c35b9f50674e6ddff994ac9b49821df58a00b140aba0f962c8cd18a4a19c37880cb02dd524bd5bf5178ab73f5f3dd0ecc9ba048dd30de3fd99ff3e8dae7bbb70d74d6b2dde2890eb735fa67ba2950e1bddb72a0e746138fa5a3f58051638a33ca08b04422f09835bf45a9cbeeb5433561169719a034c5928c17fe2a52d8621834f90ce268937b9a7c1b2f9611047c390a82fcb23fa0df4ada55e105778e2430d5020587cc6e13fb2e6d61ffd5a49251b81c6b109b6ea005212bc682370d70fa15a9617e81b55b06e5708ecf7ce9d684a192166e2244e7a03302fa1ef85ee7c0205ef0e494fcad89093c29b452cc21bf6000301344f0ced3a077e7413e78bd67837748c66aef41a9f4849774d6b873fde6fbb8d4205a2a4e56a06986a0d62186b6a3c9092895c8756152c98015cffbfac2a7e9afcde36df2a8e3a0a91aa6a9db33676e5b085e47058c2b7aa9315dc8dc4d6e3020433d2c8fc10997a054bb0ae087c80827b5247be505b6213d87fed8ae3aa39257e4019947aad53d07a0988c9d9242ed54fe693944b720ca9b69e2d170090c9a68b89174ea43d6b41e8fa04c3b4740c4e9d80665b7bda15c75b66e1ea43dbafaa42159b41867b2e94c1a3ca06a07da71da4cae2bcf7475fdd7fdb532c1bf711fffdbc97ce1ec248cc474d3d7a06c069b62a25a55f0c3f2d44349ce05c2b6b2612f5e83c9829f0666518ae06037a00f9e769b2e5d058ec87f640645cb4d0e890d61644279fd9b320c60c3fba541eaa0a4d3c4145936ba03b62aba19643ea3fbf5efee9e2345f0726f66962240c9a9d2a0861c316c0f31ea85e313cdb374bb1bad5373d17b7b8a02debf9c44285df582dba028b07193c8c8121f92ad09f01ecec9302d127e6638e989c11d8f4b23bd4c804ca0556dee416735380433ad760a94bba8a1a907eeeea5a247b344877203a4c66da5a06d95a42c5e449fcfc6a31903cb51b77b762e44b05aee766f574812ffc98e4f8fa02884a570a71b626827024ac08437f98ee7e6a98732fb7d8065d0d4c1ff786375a0a9d79aad8ac8dcc5661df3321d4c04a56953c80152fc2c17d9d93cfe101df343a0012979d6e39b04673150989350ae609fb3e4555f56f6c8810f9d277fb02b9e68a0838b6b24a915adc1f1ddc7a4bde6b3a5e4c9dd782995f60eecffc0dec11d6510a04d500eb38fc05ea3db894df9f222f5156d2cd0cf6c6bcf257535215ff7537614a0bdf313218f472443a5d3544cb1f6f396a4ec3fa7d6c2c9482e3cfa3025e8c65aa0359baac0e24107f939aefebb862d4d5961920422ca71e9affc770ed1defc3d6fa05f8f84e26bf7e50f572d1dc45c57f3462b458b78d46e2299b7276441292cf60ea02dbe274f8bf3127c9b10bf0b3991025fc2d8f5da72bf76dce736024f4c3d59a9a08251f79e6cf4f8cb3303765b4a2f8c677fc63deb88e905e7b514a5efae09487ea06dd723634bba283b05f7ed799ea50b30e69591a0135220861985d1f4b61cb65ca0f56f47b5ba82a4c046355b9eb4d8598edd491b60bd640498e4633c3cc49c18dca043579dec0dee30e4358376af7ff0b1b4b8f06bc1684730cb4454910c06870d92a0fc5b1db221bf67452002841e13aa706562c79e1a15631da0326e255dead4c79ea07189e3d6a36fb1d33213eafea3dfd8f939db2b1838e7bc98e6113d277f45af9fa08e1634d476f84c9eff4095f4f31692733af3dc7a47cab89cd635bf49b1d48ae5a09d3a3c1fe2459b87db05a78702a75039b9548af84d65b2c261cba0676a3885b6a05d5c1ec295a4f8ab00b000c6d0f45ad763cebf8f387d87c0a1d26d46c1542115a0d09927b7dc8916c588801fdecd1820c9d343207b25c25593177a28aa0b8915dca065658bea393f918a978ab2745a1fc868b88f94382ee5ea1ee9e0167bf95a9110a0e6c07b1d59a294e2b12141b21b094efb8c14f72027d91ae27fb5ff2aa02acd33a0f82b15f84c6d0ad3f88aa24eec6744862acfccb520f1d405894efa612a31acafa0f56ae811a1194b00e48d1595dc68bef51420bf7fae749de3a0c7c59c3f36e69aa0875266a89864c8f06b7dea2d9b1f09ef9746562953bfad8dd80922856dafc454a0bdccecfb61ed554047fef751e8ee4707a45c4fbb0e7e834cf64e2968c2be8fbda09b456bd65531554ad90d890168908ea3bdfc58f0cc5680b156c49da5b0420824a02e7fcf097302f1b3a18e61462b904a31459d41ed105c1d5860ec3a9e35f36a5ca09525dca77563dd7852822f132258b4f2919f15d876b5ae68fda8d8ebb8aa5916a0ba4ca557db55403404462976630fdf57513a88fc6211646c4340d5673198fb62a0e9a2304c0fcd6f030ed81b9dbe05bc19aa5ca4840430e1a2e976b8feaf03a619a05d64ed94494979f360e5ed49a3fa14424be707cd2ff44f62d826cb1f6a1efa6ea060fff206e14aed5e2b4c042450d06ce3aea997da23e589cb4a0a96dc457ee34ba00e80bc7f13f35121d3f2a7671de7ae104f69cc70ce66d2f4225b6d308e265e1ca08508bd81d069c0934a3283a2d4dc454a4ba9491144c654dd36238aef64055e39a0ae5edf137f0a10e367d60c6fd9435a65766d6e992ebd19090bc5f5bb8cf0d03ea06a7802ee40b7b4f0ac7b18f96a0f3dd418d00ed8f42f2a2168738a34b73cc410a0682ca8f3cc5477ed1a7cc908510f9cfb2eb81626076fd941eb98abf4bebb5aa7a097f9c665a9621b09204d2e70ba4d75171972bbe3eeff289e16b6ef60a5ec709ca0cf8df27d7d15da5a807e5db01e822c5d42a83b34f8a9e416bb4b7cb4252d67a7a06b6a6c42aeb047ab9965ba1270ebcc6af1a760cfd9aca61fb8889bad143f9e73a03348f7a35df45aa064fa3e959498a3be2e2c343b8d49d32fc51e232dfd496aa5a00a3b66ce8a36dbe870a9ffc3a08954494fd1e71c77bce72988d37b513e70c577a0ad0694aff26eff892b7b2d622c76c5e2e03ac306a15a5d2bd937345c2f86f6d6a079fbd965b8589b73396bfc65f92c0f162fe4bfed0bc1fcfeada4ca3d7f603691a00725743682647adbd8bad6ee964975a6b529d16781391a23a8a612d0be1fd28aa04a755f8dbe49eeef2612a4cf9e44d0a74355cd95013d7008eb021e0b69b830c7a00017284e5790c6097b66888f424bec5e2b24f7f5f9c62ade95e512e219754ce5a00a9579a9aef600c4dd4f0322440c07ad8dd09cd3b0bb0fdd9eaad70fbfc8f3aea0bd82c892bacfb10dad0e1273ca817128772173a28aa7e0aba00d7ffd18e54df3a0b53bc76051a4a8ae5fadcc55e0a770a38f369a347b2b1646ade0d5d102746db0a09127e713772ac7aba85fa492ecf29d2f471f9bdbe77a503fbc778b20ce87186aa00da6df3822def0bfc7732a319926bd70055914cd6606189405bc5b3c1abd654aa039759197158df730433c011cb7af6a9ea93589ee41e5b48e18fc910d0be28c3aa0e170718cc3881f914df3431c2f3f8a515558cdb5627e69a13fdb2cb96bf213a3a036f2bd7604dcf696a0ec22ff4d5d5ced094b53a93699364452354e3ab3bd93b9a041ada127a1ff99b4a6f1f14d524523fe20f1fa4e72a647d5083d7a4a5869acfea00a877edb8c6b7b7526bc6c229cd8cdd339de21d424d673eec4950beefaecde62a00243d0ccedfb046c947634ff42fea52709f91ba06be0f4684e6c5e4f27d66822a042e4fc8127bb2b834b3abc4fb9de47bb179ae80c9cbec357cd1450391a6f7f25a0a6cc9d73def1f60d9befb35e4aceb7a2c6be46a97939744c2f2dad6bb6e8df14a09e9a9c75b70bc342eca0ec80a895d2212494209ccf1d9af783ce0ba5c9260d86a08b13c309bbacd67050bcef3614dbff4874b84594d1458dc779072c961abfb8a9a0d1b3910ca098f2637b460124e2c7088c1947681587a6662b64526fcc8f68a22da0762086b607a47859d4018b01487ef188f7f280579ebe334782a3507697ce7d4ba0bc0b87454bf0438e4fccf21910ce62a3d8c40eb880ef9a57f2b3d882e86f826ea0cfb8ce15141c0bf79624d5dcee715ab746305bc8119b561dc7ac09844f22c34ca0c2c7ca94ce41dbdcb7d1a6c3f85792722649f4010c66741488efa25f515be2a8a00b42aa045b513f82f0b32b0e9ca88b521826b6b1f0ca348f3d67924d3ae66003a0126a7b41f605f249aa47446faab476db7e79b39d73771d2519d4a73d396625b5a028872d6fe710126a7096740e1c5ffc341bb4cd126c84ab58a3e57c396791e4b2a0c78163f4d147ca5be4bf75cae2f86fdce32afea03d00c7092364693aa29a42cea0d28837c58c3db04ecea336e6980f81941a3d7725b914e9e8e5561e320541bc4ea01a96ebff57b29238eb15ddd15ffaf42b05d0cc28097f84c9123352383fec18b0a00bbbc5908aef7c0caf82700e49a1e84f2b9cbcaf1c25ac7669a593b0ad5068eca01ceeb1fb93cf48040ba5f3f138029908672904871928136098525d298da2d6e9a0118dcbbe564b15ac2ef1168dacdd07365d84d72d2c4b1b1e8ba8763c4cd6aed3a080991ea8d8c4fd76473e5b82f0a48416cb2250117f7c5c77e6c5b0213fc2b10ba0344ba6cd55627220fe1b2ac9bd99bf116eb08f5bacd7899f4ec0c8e120e0b49fa0c2a09eb87f53101d951130f7a75b98bd2c9d0c844a6a3891939c644daefd4e39a0d4bf98a756b2018bac672f4917067c6c1fb63e79da84114a8a4e1d1b60dedd88a03032a4de0a108df41148458d644eb8350d663649e2c15683c23cb3633799cf62a0d21ecfb39b87accbab840d7aefae163c0db6b831b8e2ac049bccb2d393cbcb7ca0ba6763eb941d470c7bde88cd5f82b0155129541259cb99bc78f0de246c06da4aa08e98dec93d90e76d46a94220efacb9ba8a9c0fda00950c8faabdf78fad46af33a07cd0e814c927430b5852cd78f6b371a1a12562a7222d29bd77c7cefd9a0fa874a0acc847df79a6d1c7c72fb8558d2fd8b9b98eceabffd2240e26d9d85daf9783c4a0d4f6c4089f12bc7a80599bbbd4b6e4726449c73f9b7b24b7c60662fee8491cffa0a7a8b16abc3687ed58db73c525d4e6934decbd72e74b2705444fcf9cd37c1a43a07810619cb184c85e7703637030a0f26937af004b519a5bbac14c9e06827ff53aa0fcfa9fcf06543329136f0c046790b56c657049a29863880073456d2dd39d3c1aa01d0d5965a362d931b5ae800c6bb65e77e7dc063c7d7d4df8b39f4e635ebe7d22a0d9b5606fe5427d32cae9cefa50de8c07516db3e82f273da9bfa1e4449ecd163fa0fd3287494fd79ba3560385470d6e5261522ad171c62ae4d807ab99dd1ed60f0ea0ad33ce9aa7e3eaede61125aa52468f8c27bb0cf0b6681edb93694e630acffa38a03884e326fff805d31129eede48f28d7a78a54ec2288dd39b51e98ea5731da00ca076077d5a505988d65cfd2322f80c5232b6af91c47047180b9d644192b3253bb6a001ac4ad57981b2296b4691ccb891b7e237cf8389703499605fa4c9fa6716c21ba00039e5b2147bd5c1b706b6b76b5c4a20c4cf2d6baa3086937031c81350784501a0e45439169505dce210314741d52ea3e32d8f02fad2f1411ad91b20f5110df902a03002d779cd67b3becdc5095030a875d9aa097f53c605f5d157ef8442531a9cfda027a1f52471879534c3806929fe4e1c9b0de22ffc17913a04eac2aef9f136dc69a0f5b653bfad534b2d94697d803ed6a0d7bb6847fd8094a1e6ddf6ce3fd9154f16a07f95bc12aad92743e7bfca4f7ea3c6cba97268c9f3106ac036d9059c69cf8808a01db0aef29ee7f9519f0da828b0b2a696fb6c373cb2e0933c7010090199cd1757a0f80a66fa22d362610f3d1d1d5490a48794b3356c2a5028d49f840bd9c0c4fed7a0832bd00c99c9308cf7c7c534f4aab178d7862be1b09967e1a8bb2c172ec753b6a0088bf542ebd0702d9037b9e69dd3e45d3a171aea889e4b31a93a92625e80f87ca07e07061312dc50b1fe6a7b14742d7f691bdcacc494c5821e9660511986fead17a06803daa71abd68fe1271dd67d35e7b6a35b68853c887d6144135345a494346ada074f366320126b7ac9115d422a102ce8f5e5c8f43c999b69bb4eb79da20abf56aa00fdf4f2acaec61d078d57d3654750727322fe8b2a908418a558429eee6c61b9ba07f628bb58812e4ad9277c2b77a2cbf18a07f4304b18e0f5b430b24a6bb1ee5aba0a6f78c9fa7d001271977360605b2e74bcc6f5fa9356a25d78faf804566a41d43a09d748421311a2afbe5b0421348cc3b006a82290739335ed1ee96c92d9f18c3efa0ad6e970bcb29b0695500182f5fc578fb56e4f1e95fb5e7e0538a302144080679a0dd79097313c17f1ea1fbc3b3c193451bcd4ebbe907990f95b7adb4c3600f027ca0e4efe6cd89680581ac68605d6de0fe82be72268c158fec50efb47e94c3518002a0118802e8d1434e39c4ca6be496da27305f8aa696b9f8f7bb90f97728bb4d19b2a095724abafd9db8a0d26e5a597dfa67c5b9576a62977739c5e43a284d710c53b3a03ab854125d91a4c171056e5d2df9ffb466196c11ff565a743625eb2af9d44d4da053a6a0dc9dad4e5d9bacb2ca125b2be550d6cee886c4af5584cde256d86b6247a0344e06303fe676f57c0df162378334ada510b694557eba5ff352c8c0acb4a647a036c4564dc5862b44902ae21d2dcfaf7550024b64934ec7eae9cdcba0f65c0d6aa03218a2fec1acde046dd5388a1a9df87186fa6d47b8dcdb1bc7c6eed30b2827ca")
	ctx := NewTxParseContext()
	slots := &TxSlots{}
	requestId, _, err := ParsePooledTransactions66(bb, 0, ctx, slots)
	require.NoError(t, err)
	fmt.Printf("a: %d\n", requestId)
}
func TestPooledTransactionsPacket66(t *testing.T) {
	for i, tt := range ptp66EncodeTests {
		t.Run(strconv.Itoa(i), func(t *testing.T) {
			require := require.New(t)
			var encodeBuf []byte
			var err error
			encodeBuf = EncodePooledTransactions66(tt.txs, tt.requestId, encodeBuf)
			require.Equal(tt.expectedErr, err != nil)
			require.Equal(tt.encoded, fmt.Sprintf("%x", encodeBuf))

			ctx := NewTxParseContext()
			slots := &TxSlots{}
			requestId, _, err := ParsePooledTransactions66(encodeBuf, 0, ctx, slots)
			require.NoError(err)
			require.Equal(tt.requestId, requestId)
			require.Equal(len(tt.txs), len(slots.txs))
			require.Equal(fmt.Sprintf("%x", tt.txs[0]), fmt.Sprintf("%x", slots.txs[0].rlp))
			require.Equal(fmt.Sprintf("%x", tt.txs[1]), fmt.Sprintf("%x", slots.txs[1].rlp))
		})
	}
}
